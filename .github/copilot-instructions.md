# act-lens プロジェクト指示書

## プロジェクト概要

**act-lens**は、ローカルでGitHub Actionsワークフローを実行（act使用）し、失敗時のログを整形してAIチャットに貼り付けやすくする軽量CLIツール。

### 名前の由来
**act-lens** = actの出力を「レンズ」で覗いて整形する
- 生のログを「見やすく」整形
- 必要な情報に「フォーカス」
- エラーを「クリア」に表示

## 設計原則（必須遵守）

1. **シンプル第一** - 300-400行以内、過剰な機能を付けない
2. **単一責任** - CIログの整形に集中
3. **手動優先** - AIへの貼り付けは手動で行う（柔軟性と制御）
4. **拡張性** - 必要になってから機能追加

### ci-helperプロジェクトの教訓
- ❌ API統合は不要 → 手動貼り付けの方が柔軟
- ❌ 複数プロバイダー対応は過剰 → どのAIでもMarkdown貼り付けで十分
- ❌ キャッシュ・コスト管理は複雑すぎる → CIは毎回実行すべき
- ✅ 必要なのは「実行 → 整形 → コピー」のみ

## 技術スタック

### 依存関係（4つのみ、厳守）
```toml
dependencies = [
    "typer>=0.12.0",     # モダンなCLI（型ヒント、Rich統合）
    "rich>=13.7.0",      # 美しいターミナル出力
    "pydantic>=2.0",     # データバリデーション
    "pyperclip>=1.8.0",  # クリップボード操作（事実上の標準）
]

[dependency-groups]
dev = [
    "ruff>=0.0.0",       # リンター・フォーマッター
    "basedpyright>=1.19.0",       # 型チェッカー
    "pytest>=7.0.0",     # テストフレームワーク
    "pytest-cov>=4.0.0", # カバレッジ
    "bandit>=1.7.0",     # セキュリティチェック
    "safety>=2.0.0",     # 依存関係の脆弱性チェック
    "pre-commit>=3.0.0", # Git hookマネージャー
    # 必要に応じて追加可能
]
```

**重要**: 4つの制限は本番依存関係（`dependencies`）のみ。開発依存関係（`dev`）は制限なし。

**Typer採用理由**:
- 型ヒント完全サポート（Python 3.11+の最新機能）
- 自動的な型変換とバリデーション
- Rich統合（美しい出力）
- インタラクティブプロンプト機能
- 2024年もアクティブに開発中

**Pydantic v2採用理由**:
- 自動バリデーション（Rust実装で高速）
- JSON/辞書との相互変換が簡単
- 型安全性（Python 3.11+の型ヒントと完全統合）
- Typerとの自然な統合

**pyperclip採用理由**:
- クロスプラットフォームクリップボード操作の事実上の標準
- 月間数百万ダウンロード、安定した実績
- より良い代替技術は存在しない
- システムコマンド直接呼び出しより信頼性が高い

### 外部ツール（前提条件）
- **act** - GitHub Actionsローカル実行
- **Docker** - actの実行環境

## アーキテクチャ

### ファイル構造（目標: 300-400行）
```
act-lens/
├── pyproject.toml
├── README.md
└── src/
    └── act_lens/
        ├── __init__.py
        ├── cli.py           # CLIエントリーポイント（Typer）
        ├── runner.py        # act実行とログキャプチャ
        ├── parser.py        # ログ解析とエラー抽出
        ├── formatter.py     # Markdown生成
        ├── models.py        # Pydanticデータモデル
        └── utils.py         # ヘルパー関数
```

### データモデル
```python
class FailureInfo(BaseModel):
    workflow: str              # "ci.yml"
    job: str                   # "test"
    step: str                  # "Run pytest"
    timestamp: datetime
    duration: float            # 秒数
    error_type: str            # "ASSERTION", "TIMEOUT", etc.
    message: str               # エラーメッセージ
    file_path: str | None      # "tests/test_calculation.py"
    line_number: int | None    # 42
    context_lines: list[str]   # コード前後の行
    stack_trace: str | None    # スタックトレース全体
```

## コーディング規約

### 言語とツール
- **日本語使用**: コメント、docstring、エラーメッセージ、応答すべて日本語で記述
- **パッケージマネージャ**: `uv`を使用（`python`/`python3`の直接実行は禁止）
- **リント**: `ruff` + `basedpyright`
- **セキュリティ**: `Bandit` + `Safety` + `CodeQL`
- **テスト**: `pytest`
- **CI/CD**: `pre-commit`でリント・セキュリティチェック実行
- **依存関係更新**: `dependabot` + automerge

### 開発フロー
1. 機能実装 → 動作確認
2. 機能チェック完了後にテスト作成
3. pre-commitで自動チェック
4. CIでセキュリティ・品質検証

### Python スタイル
- Python 3.11以上を使用
- 型ヒントを必ず使用（Typer/Pydanticとの統合）
- 関数は単一責任を保つ
- docstringは簡潔に（過度なドキュメントは不要）

### コード品質
- 各ファイルは50-80行を目安に保つ
- 複雑なロジックは避け、読みやすさ優先
- エラーハンドリングは適切に（ユーザーフレンドリーなメッセージ）

### Rich使用ガイドライン
- エラー: `[red]` または `[bold red]`
- 成功: `[green]` または `[bold green]`
- 情報: `[blue]` または `[cyan]`
- 警告: `[yellow]`
- パス/ファイル名: `[bold]`

## 意図的に実装しない機能

以下の機能は**絶対に実装しない**こと：

- ❌ AI API統合（手動貼り付けの方が柔軟）
- ❌ 自動修正提案（手動修正の方が安全で学習になる）
- ❌ 複数フォーマット対応（Markdownで十分）
- ❌ キャッシュ機構（複雑性を増すだけ）
- ❌ 統計・分析機能（シンプルさを保つ）
- ❌ Git統合（必要になってから）
- ❌ 通知機能（ターミナルで完結）

理由を聞かれたら、ci-helperの教訓を説明すること。

## 実装フェーズ

### Phase 1: MVP（最小実装） ← 現在ここ
1. プロジェクト構造作成
2. `act-lens` 基本実装
   - act実行とログキャプチャ
   - エラー解析
   - Markdown生成
   - クリップボードコピー
3. 基本的な動作確認

### Phase 2以降
実際に使って効果を検証してから検討。必要性が確認できるまで実装しない。

## 成功指標

### 定量的
- **コード量**: 300-400行（厳守）
- **依存関係**: 4つ（厳守）
- **実行時間**: act実行時間 + 3秒以内
- **生成ファイル**: 10KB以内

### 定性的
- ✅ 1コマンドで失敗ログをAIに渡せる
- ✅ 5分以内にセットアップ完了
- ✅ ドキュメント不要で直感的に使える
- ✅ ci-helperの複雑さを感じない

## コード生成時の注意

1. **新しい機能を提案する前に**、この指示書を再確認すること
2. **依存関係を追加する前に**、4つの制限を思い出すこと
3. **複雑なロジックを書く前に**、シンプルな方法がないか考えること
4. **コード行数が増えたら**、リファクタリングまたは機能削除を検討すること

詳細な設計ドキュメント: `docs/design.md`
